name: NBA Analytics Pipeline

on:
  # Scheduled runs
  schedule:
    # Nightly at 2:00 AM UTC
    - cron: "0 2 * * *"
    # Weekly on Sunday at 3:00 AM UTC
    - cron: "0 3 * * 0"
    # Monthly on the 1st at 4:00 AM UTC
    - cron: "0 4 1 * *"
  # Manual trigger
  workflow_dispatch:

jobs:
  run_pipeline:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create results directory
      run: mkdir -p results

    - name: Run full NBA analytics pipeline
      run: |
        python -m scripts.setup_all --skip-fetch --skip-train
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    - name: Upload picks artifact
      uses: actions/upload-artifact@v3
      with:
        name: picks
        path: results/picks.csv

    - name: Upload metrics artifact
      uses: actions/upload-artifact@v3
      with:
        name: metrics
        path: results/simulation_metrics_*.json
