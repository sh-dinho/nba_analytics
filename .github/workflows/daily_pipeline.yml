name: NBA Analytics Pipeline

on:
  schedule:
    - cron: "0 9 * * *"   # Daily run
    - cron: "0 12 * * 0"  # Weekly run every Sunday at 12 UTC
  workflow_dispatch:

jobs:
  nba-pipeline:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        model_type: [logistic, xgb, nn]
    steps:
      # ... (same as before: train, run, upload results)

  aggregate:
    runs-on: ubuntu-latest
    needs: nba-pipeline
    steps:
      # ... (same as before: aggregate daily, upload chart, send Telegram)

  weekly-aggregate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: Weekly aggregation
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          python scripts/weekly_aggregate.py

      - name: Upload weekly summary
        uses: actions/upload-artifact@v4
        with:
          name: nba-weekly-summary
          path: results/weekly_summary.csv

      - name: Upload weekly AI insight
        uses: actions/upload-artifact@v4
        with:
          name: nba-weekly-ai-insight
          path: results/weekly_ai_insight.txt

      - name: Send Telegram weekly report
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          insight=$(cat results/weekly_ai_insight.txt)
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d parse_mode=Markdown \
            -d text="*ðŸ“… Weekly NBA Report*\n\n$(cat results/weekly_summary.csv)\n\n${insight}"