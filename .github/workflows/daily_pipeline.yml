# ============================================================
# File: .github/workflows/nba_pipeline.yml
# Purpose: End-to-end NBA pipeline with refinements
# ============================================================

name: NBA End-to-End Pipeline

on:
  schedule:
    - cron: "0 17 * * *"   # 12:00 EST (winter)
    - cron: "0 16 * * *"   # 12:00 EDT (summer)
  workflow_dispatch:
    inputs:
      threshold:
        description: "Prediction threshold"
        default: "0.6"
        required: false
      strategy:
        description: "Bankroll strategy"
        default: "kelly"
        required: false
      max_fraction:
        description: "Max bankroll fraction"
        default: "0.05"
        required: false
  push:
    branches:
      - main

concurrency:
  group: nba-end-to-end
  cancel-in-progress: true

jobs:
  # -------------------------------
  # 1. Fetch NBA data & features
  # -------------------------------
  fetch-data:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/cache@v4
        id: cache-venv
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt

      - run: echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH
      - run: python scripts/fetch_data.py
      - run: python scripts/feature_pipeline.py

      - uses: actions/upload-artifact@v4
        with:
          name: nba-daily-data
          path: data/
          retention-days: 7

  # -------------------------------
  # 2. Train models & bankroll
  # -------------------------------
  train-models:
    needs: fetch-data
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        model_type: [logistic, xgb, nn]
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/core
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/cache@v4
        id: cache-venv
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt

      - run: echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH

      - uses: actions/download-artifact@v4
        with:
          name: nba-daily-data
          path: data

      - run: |
          mkdir -p models logs results
          python scripts/train_model.py --model_type ${{ matrix.model_type }}

      - run: |
          python app/prediction_pipeline.py \
            --threshold ${{ github.event.inputs.threshold || '0.6' }} \
            --strategy ${{ github.event.inputs.strategy || 'kelly' }} \
            --max_fraction ${{ github.event.inputs.max_fraction || '0.05' }} \
            --model_type ${{ matrix.model_type }}

      - uses: actions/upload-artifact@v4
        with:
          name: model-${{ matrix.model_type }}
          path: models/
          retention-days: 30

      - uses: actions/upload-artifact@v4
        with:
          name: bankroll-${{ matrix.model_type }}
          path: results/picks_bankroll_${{ matrix.model_type }}.csv
          retention-days: 30

      - uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.model_type }}
          path: logs/
          retention-days: 14

  # -------------------------------
  # 3. Aggregate & reporting
  # -------------------------------
  aggregate:
    needs: train-models
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/core
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/cache@v4
        id: cache-venv
        with:
          path: .venv
          key: venv-${{ runner.os }}-py3.12-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m venv .venv
          .venv/bin/pip install --upgrade pip
          .venv/bin/pip install -r requirements.txt

      - run: echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH

      - uses: actions/download-artifact@v4
        with:
          path: results_all

      - run: |
          mkdir -p results models logs
          mv results_all/bankroll-* results/ 2>/dev/null || true
          mv results_all/model-* models/ 2>/dev/null || true
          mv results_all/logs-* logs/ 2>/dev/null || true

      - run: python scripts/aggregate_results.py
      - run: python scripts/monthly_aggregate.py
      - run: python scripts/dashboard.py

      - name: Send Telegram report
        if: ${{ env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != '' }}
        run: python scripts/telegram_report.py

      - uses: actions/upload-artifact@v4
        with:
          name: final-aggregate-summary
          path: results/aggregate_summary.csv
          retention-days: 30

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: aggregate-logs
          path: logs/
          retention-days: 14
