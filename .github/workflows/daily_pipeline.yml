name: NBA Analytics Pipeline

on:
  # Scheduled runs
  schedule:
    - cron: "0 2 * * *"   # Nightly at 2:00 AM UTC
    - cron: "0 3 * * 0"   # Weekly on Sunday at 3:00 AM UTC
    - cron: "0 4 1 * *"   # Monthly on the 1st at 4:00 AM UTC
  # Manual trigger
  workflow_dispatch:

jobs:
  run_pipeline:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install project
      run: pip install -e .

    - name: Create results directory
      run: mkdir -p results

    - name: Run full NBA analytics pipeline
      run: |
        python -m scripts.setup_all --skip-fetch --skip-train
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    - name: Upload picks artifact
      uses: actions/upload-artifact@v4
      with:
        name: picks
        path: results/picks.csv
        if-no-files-found: warn

    - name: Upload metrics artifact
      uses: actions/upload-artifact@v4
      with:
        name: metrics
        path: results/simulation_metrics_*.json
        if-no-files-found: warn