name: Nightly Retrain, Predictions, and Comparison

on:
  schedule:
    - cron: "0 6 * * *"   # every day at 6:00 UTC
  workflow_dispatch:

jobs:
  retrain_and_predict:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Enrich schedule (with backup)
        run: |
          python -m src.scripts.enrich_schedule --season 2025 || echo "Schedule enrichment failed"
          mkdir -p data/backups
          cp data/cache/schedule.csv data/backups/schedule_backup_$(date +%F).csv || echo "No schedule file to back up"
          # also write parquet for generate_features if CSV exists
          if [ -f data/cache/schedule.csv ]; then
            python -c "import pandas as pd; df=pd.read_csv('data/cache/schedule.csv'); df.to_parquet('data/cache/historical_schedule.parquet', index=False)"
          fi
        continue-on-error: true

      - name: Generate features (resilient)
        run: |
          python -m src.scripts.generate_features || echo "Feature generation failed"
          # ensure features_full.parquet exists even if script failed
          if [ ! -f data/cache/features_full.parquet ]; then
            mkdir -p data/cache
            python -c "import pandas as pd; pd.DataFrame(columns=['GAME_ID','SEASON','PTS','PTS_OPP','WL']).to_parquet('data/cache/features_full.parquet', index=False)"
            echo "Empty features file written"
          fi
        continue-on-error: true

      - name: Retrain model and log metrics
        run: |
          python -m src.model_training.trainer_cli \
            --model xgb \
            --season 2025 \
            --features data/cache/features_full.parquet \
            --out models/nba_xgb.pkl \
            --metrics_out data/results/model_metrics.csv \
            --importance_out data/results/feature_importance.csv

      - name: Generate predictions and player info
        run: |
          python -m src.prediction_engine.daily_runner_cli \
            --model models/nba_xgb.pkl \
            --season 2025 \
            --limit 10 \
            --out data/results/daily_predictions.csv \
            --fmt csv

      - name: Compare algorithms
        run: python -m src.model_training.compare_algorithms

      - name: Commit updated results and backups
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add models/nba_xgb.pkl \
                 data/results/daily_predictions.csv \
                 data/results/player_info.csv \
                 data/results/model_metrics.csv \
                 data/results/feature_importance.csv \
                 data/results/model_comparison.csv \
                 data/cache/schedule.csv \
                 data/backups/schedule_backup_*.csv \
                 data/cache/features_full.parquet
          git commit -m "chore: nightly retrain, predictions, player info, algorithm comparison, and schedule backup" || echo "No changes to commit"
          git push
